name: NetsPresso QA Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install torch torchvision netspresso pytest pytest-html
        fi
        pip install pytest pytest-html pytest-json-report
    
    - name: Create test directories
      run: |
        mkdir -p tests
        mkdir -p results/test_results
        mkdir -p results/reports
    
    - name: Check for test files
      id: check_tests
      run: |
        if [ -f "tests/test_basic_functionality.py" ]; then
          echo "has_tests=true" >> $GITHUB_OUTPUT
          echo "âœ… í…ŒìŠ¤íŠ¸ íŒŒì¼ ë°œê²¬"
        else
          echo "has_tests=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ì–´ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ìƒì„±"
        fi
    
    - name: Create basic test file (if not exists)
      if: steps.check_tests.outputs.has_tests == 'false'
      run: |
        cat > tests/test_basic_functionality.py << 'EOF'
        """
        ê¸°ë³¸ NetsPresso ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        """
        import pytest
        import os
        import sys
        from datetime import datetime
        
        # í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ pathì— ì¶”ê°€
        sys.path.append(os.path.join(os.path.dirname(__file__), '..'))
        
        class TestNetsPresso:
            """NetsPresso ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"""
            
            def test_api_key_exists(self):
                """API í‚¤ ì¡´ì¬ í™•ì¸"""
                api_key = os.environ.get('NETSPRESSO_API_KEY')
                assert api_key is not None, "NETSPRESSO_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
                assert len(api_key) > 10, "API í‚¤ê°€ ë„ˆë¬´ ì§§ìŒ"
                
            def test_netspresso_import(self):
                """NetsPresso ë¼ì´ë¸ŒëŸ¬ë¦¬ import í…ŒìŠ¤íŠ¸"""
                try:
                    import netspresso
                    from netspresso import NetsPresso
                    assert True
                except ImportError as e:
                    pytest.skip(f"NetsPresso ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ: {e}")
            
            def test_basic_connection(self):
                """ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸"""
                try:
                    import netspresso
                    from netspresso import NetsPresso
                    
                    api_key = os.environ.get('NETSPRESSO_API_KEY')
                    if not api_key:
                        pytest.skip("API í‚¤ê°€ ì—†ì–´ ì—°ê²° í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ")
                        
                    client = NetsPresso(api_key=api_key)
                    user_info = client.get_user_info()
                    
                    assert user_info is not None
                    assert 'email' in user_info or 'id' in user_info
                    print(f"âœ… ì—°ê²° ì„±ê³µ: {user_info.get('email', 'Unknown user')}")
                    
                except ImportError:
                    pytest.skip("NetsPresso ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ")
                except Exception as e:
                    pytest.fail(f"ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
            
            def test_torch_available(self):
                """PyTorch ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í…ŒìŠ¤íŠ¸"""
                try:
                    import torch
                    import torch.nn as nn
                    
                    # ê°„ë‹¨í•œ ëª¨ë¸ ìƒì„± í…ŒìŠ¤íŠ¸
                    model = nn.Sequential(
                        nn.Linear(10, 5),
                        nn.ReLU(),
                        nn.Linear(5, 1)
                    )
                    
                    # ë”ë¯¸ ì…ë ¥ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
                    x = torch.randn(1, 10)
                    output = model(x)
                    
                    assert output.shape == (1, 1)
                    print("âœ… PyTorch ëª¨ë¸ ìƒì„± ë° ì‹¤í–‰ ì„±ê³µ")
                    
                except ImportError:
                    pytest.skip("PyTorchê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ")
            
            def test_file_system_access(self):
                """íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸"""
                import tempfile
                import os
                
                # ì„ì‹œ íŒŒì¼ ìƒì„± ë° ì ‘ê·¼ í…ŒìŠ¤íŠ¸
                with tempfile.NamedTemporaryFile(mode='w', delete=False) as f:
                    f.write("test content")
                    temp_path = f.name
                
                try:
                    # íŒŒì¼ ì½ê¸° í…ŒìŠ¤íŠ¸
                    with open(temp_path, 'r') as f:
                        content = f.read()
                    
                    assert content == "test content"
                    
                    # results ë””ë ‰í† ë¦¬ ìƒì„± í…ŒìŠ¤íŠ¸
                    os.makedirs('results/test_results', exist_ok=True)
                    assert os.path.exists('results/test_results')
                    
                    print("âœ… íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ ì„±ê³µ")
                    
                finally:
                    # ì„ì‹œ íŒŒì¼ ì‚­ì œ
                    if os.path.exists(temp_path):
                        os.unlink(temp_path)

        class TestReportGeneration:
            """ë¦¬í¬íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸"""
            
            def test_json_report_creation(self):
                """JSON ë¦¬í¬íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸"""
                import json
                from datetime import datetime
                
                # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°ì´í„° ìƒì„±
                test_result = {
                    "test_name": "pytest_basic_test",
                    "timestamp": datetime.now().isoformat(),
                    "result": {
                        "success": True,
                        "details": {
                            "test_type": "pytest_integration",
                            "environment": "github_actions"
                        }
                    }
                }
                
                # results ë””ë ‰í† ë¦¬ ìƒì„±
                os.makedirs('results/test_results', exist_ok=True)
                
                # JSON íŒŒì¼ ì €ì¥
                filename = f'results/test_results/pytest_result_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
                with open(filename, 'w', encoding='utf-8') as f:
                    json.dump(test_result, f, ensure_ascii=False, indent=2)
                
                # íŒŒì¼ ì¡´ì¬ í™•ì¸
                assert os.path.exists(filename)
                
                # íŒŒì¼ ë‚´ìš© í™•ì¸
                with open(filename, 'r', encoding='utf-8') as f:
                    loaded_data = json.load(f)
                
                assert loaded_data['test_name'] == 'pytest_basic_test'
                assert loaded_data['result']['success'] is True
                
                print(f"âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼ JSON íŒŒì¼ ìƒì„±: {filename}")
        EOF
        echo "âœ… ê¸°ë³¸ í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„± ì™„ë£Œ"
    
    - name: Run pytest tests
      env:
        NETSPRESSO_API_KEY: ${{ secrets.NETSPRESSO_API_KEY }}
      run: |
        echo "ğŸ§ª pytest í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        python -m pytest tests/ -v --tb=short --json-report --json-report-file=results/pytest_report.json --html=results/pytest_report.html --self-contained-html
      continue-on-error: true
    
    - name: Run additional NetsPresso tests
      env:
        NETSPRESSO_API_KEY: ${{ secrets.NETSPRESSO_API_KEY }}
      run: |
        echo "ğŸ” ì¶”ê°€ NetsPresso í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        
        if [ -f "src/netspresso_client.py" ]; then
          echo "NetsPresso í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰ ì¤‘..."
          python src/netspresso_client.py || echo "í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰ ì™„ë£Œ (ì¼ë¶€ ì˜¤ë¥˜ ê°€ëŠ¥)"
        fi
        
        if [ -f "src/ci_netspresso_test.py" ]; then
          echo "CI í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
          python src/ci_netspresso_test.py || echo "CI í…ŒìŠ¤íŠ¸ ì™„ë£Œ (ì¼ë¶€ ì˜¤ë¥˜ ê°€ëŠ¥)"
        fi
      continue-on-error: true
    
    - name: Convert test results to standard format
      run: |
        echo "ğŸ”„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ì¤‘..."
        if [ -f "scripts/test_result_saver.py" ]; then
          python scripts/test_result_saver.py
        else
          echo "âš ï¸ test_result_saver.py ì—†ìŒ, pytest ê²°ê³¼ë§Œ ì‚¬ìš©"
        fi
    
    - name: Generate QA report
      run: |
        echo "ğŸ“Š QA ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."
        if [ -f "scripts/generate_qa_report.py" ]; then
          python scripts/generate_qa_report.py
        else
          echo "âš ï¸ generate_qa_report.py ì—†ìŒ, ê¸°ë³¸ ë¦¬í¬íŠ¸ ìƒì„±"
          python3 << 'PYTHON_SCRIPT'
        import json
        import os
        from datetime import datetime

        # pytest ê²°ê³¼ ì½ê¸°
        pytest_report_path = 'results/pytest_report.json'
        report_content = '# NetsPresso QA í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸\n\n'
        report_content += f'**ìƒì„± ì‹œê°**: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}\n\n'

        if os.path.exists(pytest_report_path):
            try:
                with open(pytest_report_path, 'r', encoding='utf-8') as f:
                    pytest_data = json.load(f)
                
                summary = pytest_data.get('summary', {})
                total = summary.get('total', 0)
                passed = summary.get('passed', 0)
                failed = summary.get('failed', 0)
                
                report_content += '## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½\n\n'
                report_content += f'| í•­ëª© | ê°’ |\n'
                report_content += f'|------|----:|\n'
                report_content += f'| ì „ì²´ í…ŒìŠ¤íŠ¸ | {total}ê°œ |\n'
                report_content += f'| ì„±ê³µ | {passed}ê°œ |\n'
                report_content += f'| ì‹¤íŒ¨ | {failed}ê°œ |\n'
                
                if total > 0:
                    success_rate = (passed / total) * 100
                    report_content += f'| ì„±ê³µë¥  | {success_rate:.1f}% |\n'
                
                report_content += '\n## ğŸ” ìƒì„¸ ê²°ê³¼\n\n'
                
                # í…ŒìŠ¤íŠ¸ë³„ ê²°ê³¼
                tests = pytest_data.get('tests', [])
                for test in tests[:10]:  # ì²˜ìŒ 10ê°œë§Œ
                    status = 'âœ…' if test.get('outcome') == 'passed' else 'âŒ'
                    name = test.get('nodeid', 'Unknown test')
                    report_content += f'### {status} {name}\n\n'
                    
            except Exception as e:
                report_content += f'pytest ê²°ê³¼ íŒŒì‹± ì˜¤ë¥˜: {e}\n\n'
        else:
            report_content += 'âš ï¸ pytest ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n'

        # ê¸°ë³¸ ê¶Œì¥ì‚¬í•­ ì¶”ê°€
        report_content += '''## ğŸ¯ QA ê¶Œì¥ì‚¬í•­

        ### ìš°ì„ ìˆœìœ„ ë†’ìŒ
        - ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•  ìˆ˜ ìˆë„ë¡ í™˜ê²½ ì„¤ì • ê²€í† 
        - API í‚¤ ì„¤ì • ë° ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ í™•ì¸

        ### ê°œì„  ì œì•ˆ  
        - ë” ë§ì€ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€
        - ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê³ ë ¤
        - ìë™í™”ëœ ë°°í¬ í…ŒìŠ¤íŠ¸ ì¶”ê°€

        ---
        *ì´ ë¦¬í¬íŠ¸ëŠ” GitHub Actionsì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
        '''

        # ë¦¬í¬íŠ¸ ì €ì¥
        os.makedirs('results', exist_ok=True)
        with open('results/qa_summary_report.md', 'w', encoding='utf-8') as f:
            f.write(report_content)

        print('âœ… QA ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ')
        PYTHON_SCRIPT
    
    - name: Generate enhanced test summary
      if: always()
      run: |
        echo "ğŸ“ í–¥ìƒëœ í…ŒìŠ¤íŠ¸ ìš”ì•½ ìƒì„± ì¤‘..."
        {
          echo "=== NetsPresso QA í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼ ==="
          echo "ì‹¤í–‰ ì‹œê°„: $(date)"
          echo "GitHub Run ID: ${{ github.run_id }}"
          echo "ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}"
          echo "íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo ""
          echo "=== íŒŒì¼ í™•ì¸ ==="
          echo "ìƒì„±ëœ íŒŒì¼ë“¤:"
          find results/ -type f -name "*.json" -o -name "*.html" -o -name "*.md" 2>/dev/null || echo "ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
          echo ""
          echo "=== ë””ë ‰í† ë¦¬ êµ¬ì¡° ==="
          ls -la results/ 2>/dev/null || echo "results ë””ë ‰í† ë¦¬ ì—†ìŒ"
        } > test_summary.txt
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          test_summary.txt
          results/
          htmlcov/
        retention-days: 30
    
    - name: Comment on PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê²°ê³¼\n\n';
          comment += `**ì‹¤í–‰ ì‹œê°„**: ${new Date().toISOString()}\n`;
          comment += `**ì›Œí¬í”Œë¡œìš° ID**: ${{ github.run_id }}\n\n`;
          
          // QA ë¦¬í¬íŠ¸ê°€ ìˆìœ¼ë©´ í¬í•¨
          try {
            if (fs.existsSync('results/qa_summary_report.md')) {
              const report = fs.readFileSync('results/qa_summary_report.md', 'utf8');
              const lines = report.split('\n');
              const summary = lines.slice(0, 20).join('\n');
              comment += `### QA ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°\n\n${summary}\n\n`;
            }
          } catch (error) {
            comment += `âš ï¸ QA ë¦¬í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${error.message}\n\n`;
          }
          
          // pytest ê²°ê³¼ í¬í•¨
          try {
            if (fs.existsSync('results/pytest_report.json')) {
              const pytest = JSON.parse(fs.readFileSync('results/pytest_report.json', 'utf8'));
              const summary = pytest.summary || {};
              comment += `### Pytest ê²°ê³¼\n`;
              comment += `- ì „ì²´: ${summary.total || 0}ê°œ\n`;
              comment += `- ì„±ê³µ: ${summary.passed || 0}ê°œ\n`;
              comment += `- ì‹¤íŒ¨: ${summary.failed || 0}ê°œ\n\n`;
            }
          } catch (error) {
            comment += `âš ï¸ Pytest ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨: ${error.message}\n\n`;
          }
          
          comment += `ğŸ”— [ì „ì²´ ê²°ê³¼ ë° ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Update main branch with results
      if: github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f "results/qa_summary_report.md" ]; then
          git add results/qa_summary_report.md
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“Š Update QA summary report [automated]
            
        - í…ŒìŠ¤íŠ¸ ì‹¤í–‰: ${{ github.run_id }}
        - ìƒì„± ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
            git push
          fi
        fi